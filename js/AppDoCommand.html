<script>
/**
 * client commands switch block
 * most of these are primarily driven by mouse clicks, usually on button elements
 */
app.doCommand = function(command,...options) {
  switch(command) {
    case 'archivedForms':
      if(!app.changes.saved) {
        app.modal.handleUnsavedForm(command);
        return;
      }
      let today = new Date();
      today.setHours(0); today.setMinutes(0); today.setSeconds(0); today.setMilliseconds(0);
      if(new Date(app.pages.archive.range.end + 'T00:00:00').getTime() >= today.getTime()) {
        app.pages.archive.update();
      } else {
        app.pages.archive.query();
      }
      app.showPage(app.pages.archive);
      app.cache.currentFormstack = 'archive';
      break;
    case 'changeLog':
      app.modal.displayChangeLog(JSON.parse(app.pages.form.elements.form.notes.value));
      break;
    case 'codabar':
      // NetID is sitting in app.modal.input, new codabar is sitting in omnibox AND app.modal.tmp
      // need to update Students sheet and then parse omnibox
      app.run.doPost({ post: 'codabar', netId: app.modal.getInput(), codabar: app.modal.tmp });
      break;
    case 'demo':
      app.spinner.on();
      app.run.doPost({ post: 'demo' });
      break;
    case 'displayForm':
      let form = options[0],
          isArchive = Boolean(options[1]);
      displayForm(form, isArchive);
      break;
    case 'displayNewForm':
      if(!app.changes.saved) {
        app.modal.handleUnsavedForm(command);
        return;
      }
      displayNewForm();
      break;
    case 'itemNote':
    //@todo this and studentNote and saveNote are redundant and need refactoring!
      app.modal.handleError(new Error('Not available yet!'));
      break;
    case 'itemQuantity':
      let itemId = app.modal.tmp;
      let quantity = +app.modal.getInput();
      let items = JSON.parse(app.pages.form.elements.form.items.value);
      let item = items.find(i => i.id == itemId);
      let itemchange = {
        target: {
          name: 'items',
          value: itemId + ' qty ' + item.quantity,
        }
      }
      if (quantity < 1 || isNaN(quantity) || Math.floor(quantity) != quantity) {
        app.modal.handleError(new Error("Invalid quantity: " + quantity + ". Use a positive number.  Scan the item again to check-in."));
        return;
      }
      item.quantity = quantity;
      // Update form.items
      app.pages.form.elements.form.items.value = JSON.stringify(items);
      // Update display
      utility.DOM.empty(app.pages.form.elements.itemList);
      items.forEach(populateItemList);
      // Fake change event
      itemchange.target.value += ' to ' + quantity;
      app.pages.form.handleChange(itemchange);
      break;
    case 'newNote':
      app.modal.getNote();
      break;
    case 'nextForm':
      app.pages.form.getNext(); 
      break;
    case 'openForms':
      if(!app.changes.saved) {
        app.modal.handleUnsavedForm(command);
        return;
      }
      app.spinner.on();
      app.run.doGet({ get: 'openForms' });
      break;
    case 'parseOmnibox':
      app.omnibox.parse();
      break;
    case 'previousForm':
      app.pages.form.getPrevious();
      break;
    case 'query':
      app.pages.archive.query();
      break;
    case 'revert':
      app.changes.saved = true;
      app.pages.form.elements.undoButton.setAttribute('disabled', true);
      app.pages.form.elements.updateButtonHint.textContent = '';
      app.pages.form.elements.updateFormButton.setAttribute('disabled', true);
      displayForm(app.cache.savedForm);
      break;
    case 'saveNote':
      {
        let notes = JSON.parse(app.pages.form.elements.form.notes.value);
        let note = {
          timestamp: Date.now(),
          author: app.elements.usernameDisplay.textContent,
          body: app.modal.getText(),
        };
        let noteChange = {
          target: {
            name: 'notes',
            value: note.body.length > 10 ? note.body.slice(0, 10) + '...' : note.body
          }
        }
        let p = document.createElement('p');
        p.textContent = 'Note: ' + '[' + note.author + '] ' + note.body;

        notes.push(note);
        app.pages.form.elements.form.notes.value = JSON.stringify(notes);
        app.pages.form.handleChange(noteChange);

        app.pages.form.elements.noteSection.appendChild(p);
      }
      if(app.pages.form.elements.noteSection.classList.contains('hidden')) {
        app.pages.form.elements.noteSection.classList.remove('hidden');
      }
      break;
    case 'setLocationOther':
      let otherLocation = app.modal.getInput(),
          option = app.pages.form.elements.locationOtherOption,
          select = app.pages.form.elements.form.location,
          change = {
            target: {
              name  :'location',
              value :otherLocation 
            }
          };
      select.value = option.value = otherLocation;
      app.pages.form.handleChange(change);
      option.textContent = otherLocation; // must follow handleChange
      break;
    case 'signatureRecheck':
      window.clearTimeout(app.cache.signatureTimeoutId);
      app.run.doGet({ get: 'students',  init: false});
      break;
    case 'signatureSubmit':
      let dataURL = app.modal.signaturePad.toDataURL(),
          studentId = app.modal.tmp;
      app.run.doPost({ post: 'signature', dataURL: dataURL, id: studentId });
      break;
    case 'sortOpenForms':
      let sortType = options[0];
      displayOpenForms(app.cache.openForms, sortType);
      break;
    case 'studentNote':
      let radio = app.modal.table.querySelectorAll('input[type="radio"]'),
          value;
      for(let i = 0; i < radio.length; i++) {
        if(radio[i].checked) {
          if(radio[i].value == 'other') {
            value = app.modal.getText();
            break;
          } else {
            value = radio[i].value;
            break;
          }
        }
      }
      if(!value) {
        app.modal.handleError(new Error('an error has occured while getting student note'));
      }
      // @todo this is just a cut and paste and modified version of 'saveNote' - refactor
      // let variables had to be renamed so as not to conflict
      let savedNotes = JSON.parse(app.pages.form.elements.form.notes.value);
      let newNote = {
        timestamp: Date.now(),
        author: app.elements.usernameDisplay.textContent,
        body: app.modal.tmp + ': ' + value,
      };
      let changeNote = {
        target: {
          name: 'notes',
          value: newNote.body.length > 10 ? newNote.body.slice(0, 10) + '...' : newNote.body
        }
      }
      let para = document.createElement('p');
      para.textContent = 'Note: ' + '[' + newNote.author + '] ' + newNote.body;

      savedNotes.push(newNote);
      app.pages.form.elements.form.notes.value = JSON.stringify(savedNotes);
      app.pages.form.handleChange(changeNote);

      app.pages.form.elements.noteSection.appendChild(para);
      if(app.pages.form.elements.noteSection.classList.contains('hidden')) {
        app.pages.form.elements.noteSection.classList.remove('hidden');
      }
      break;
    case 'updateForm':
      app.omnibox.parse();
      app.spinner.inside(app.pages.form.elements.updateFormButton);
      app.run.doPost({ post: 'updateForm', form: JSON.stringify(utility.makeForm()) });
      break;
    case 'undo':
      app.modal.handleUndo();
      break;
  }
};
</script>
