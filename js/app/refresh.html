<script>
/**
 * main server callback function
 * @see js/Init
 * this is attached to google.script.run.withSuccessHandler
 */
/* global
app
displayForm
populateFormsTable
toast
utility
*/

/**
 * app.refresh is the main callback attached to google.script.run.withSuccessHandler
 * @param {Object} response - from server, see gs/Main
 * @param {Object} [context] - from client, see google.script.run.withUserObject
 */
app.refresh = function(response, context) {
  switch (response.target) {
    case 'closed':
      if (response.unlock) {
        app.elements.closedButton.removeAttribute('disabled');
      } else { // remove spinner from query button
        app.pages.closed.elements.queryButton.innerHTML = 'Update View';
      }
      app.cache.closed = JSON.parse(response.formList);
      app.pages.closed.query();
      break;
    case 'checkForms': {
      const newForms = JSON.parse(response.formList);
      if (! newForms[0]) {
        break;
      }
      // determine current context, see app.pages.form.{show,hide}
      // for why timeoutId shows context
      if (context.timeoutId != app.pages.form.timeoutId ||
          app.cache.currentFormstack == app.strings.formstack.closed) {
        break;
      }
      utility.sortForms(newForms);
      const staleForm = app.cache[app.cache.currentFormstack][app.cache.currentIndex];
      const index = newForms.findIndex(form => form.id == staleForm.id);
      if (index < 0) {
        // new forms catch here
        break;
      }
      const newForm = newForms[index];
      // are changes saved?
      if (app.changes.saved) {
        app.cache.openForms = newForms;
        app.cache.currentIndex = index;
        app.doCommand("displayForm", newForm);
        app.pages.form.setTimeout();
      } else {
        if (newForm.hash != staleForm.hash) {
          // another instance has already updated this form; do not set timeout
          app.run.doPost({
            post: "rejected",
            form: JSON.stringify(utility.makeForm())
          });
          app.modal.handleError({
            target: "collision",
            storedForm: newForm,
            submittedForm: staleForm
          });
        } else { // editing the current form; keep checking
          app.pages.form.setTimeout();
        }
      }
      break;
    }
    case 'codabar':
      app.cache.students = JSON.parse(response.students);
      app.modal.hide();
      app.pages.form.elements.updateFormButton.textContent = "Update";
      app.omnibox.parse();
      break;
    case 'collision':
      response.storedForm = JSON.parse(response.storedForm);
      response.submittedForm = JSON.parse(response.submittedForm);
      app.modal.handleError(response);
      app.pages.form.elements.updateFormButton.textContent = "Update";
      break;
    case 'items':
      app.cache.items = JSON.parse(response.items);
      break;
    case 'openForms':
      if (response.unlock) {
        app.elements.openFormsButton.removeAttribute('disabled');
      }
      app.cache.currentFormstack = app.strings.formstack.openForms;
      app.changes.saved = true;
      app.cache.openForms = JSON.parse(response.formList);
      utility.sortForms(app.cache.openForms);
      populateFormsTable(app.cache.openForms);
      app.spinner.off();
      app.showPage(app.pages.openForms);
      break;
    case 'rejected':
      toast("The form you were editing was saved on the server.");
      break;
    case 'signature':
      app.cache.students = JSON.parse(response.students);
      app.omnibox.parse();
      break;
    case 'startSignature':
      app.modal.signatureReady();
      break;
    case 'students': // doCommand 'signatureRecheck' refreshes here
      app.cache.students = JSON.parse(response.students);
      if (response.unlock) {
        app.elements.newFormButton.removeAttribute('disabled');
      } else {
        app.omnibox.parse();
      }
      break;
    case 'updateForm': {
      app.changes.saved = true;
      app.pages.form.lockButtons(); // disables "update" until next change
      app.pages.form.unlock(); // allows editing of form
      const updatedForm = JSON.parse(response.form);
      const index = app.cache.openForms.findIndex(
        (form) => (! form.id || form.id == updatedForm.id)
      );
      if (index > -1) {
        app.cache.openForms[index] = updatedForm;
      } else {
        throw new Error("cannot find " + updatedForm.id + " in local forms");
      }
      populateFormsTable(app.cache.openForms); // this doesn't actually show the forms or change user's context
      app.cache.currentIndex = app.cache.openForms.findIndex( // get updated index
        (form) => (! form.id || form.id == updatedForm.id)
      );
      displayForm(updatedForm);
      break;
    }
    case 'user':
      app.elements.usernameDisplay.textContent = response.user;
      break;
  }

};
</script>
