<script>
/**
 * client commands switch block
 * most of these are primarily driven by mouse clicks, usually on button elements
 */
/* global
      app
      displayForm
      populateFormsTable
      populateArchiveTable
      populateItemList
      utility
*/
app.doCommand = function(command,...options) {
  switch (command) {
    case 'archivedForms': {
      if (!app.changes.saved) {
        app.modal.handleUnsavedForm(command);
        return;
      }
      const today = new Date();
      today.setHours(0);
      today.setMinutes(0);
      today.setSeconds(0);
      today.setMilliseconds(0);
      const selectedEndTime = new Date(
        app.pages.archive.range.end + 'T00:00:00'
      ).getTime();
      if (selectedEndTime >= today.getTime()) {
        app.pages.archive.update();
      } else {
        app.pages.archive.query();
      }
      app.showPage(app.pages.archive);
      app.cache.currentFormstack = app.strings.formstack.archive;
      break;
    }
    case 'changeLog':
      app.modal.displayChangeLog(
        JSON.parse(app.pages.form.elements.form.notes.value)
      );
      break;
    case 'codabar':
      // NetID is sitting in app.modal.input
      // new codabar is sitting in omnibox AND app.modal.tmp
      // need to update Students sheet and then parse omnibox
      app.run.doPost({
        post: 'codabar', netId: app.modal.getInput(), codabar: app.modal.tmp
      });
      break;
    case 'displayForm': {
      const form = options[0],
            isArchive = Boolean(options[1]);
      displayForm(form, isArchive);
      break;
    }
    case 'displayNewForm': {
      if (! app.changes.saved) {
        app.modal.handleUnsavedForm(command);
        return;
      }
      app.cache.savedForm = {
        id: null, bookingId: null, bookedStudents: null, endTime: null,
        location: null, overnight: null, project: null, contact: null,
        startTime: null, tape: null, students: [], items: [], notes: []
      };
      app.cache.currentFormstack = app.strings.formstack.openForms;
      const length = app.cache.openForms.push(app.cache.savedForm);
      app.cache.currentIndex = length - 1;
      app.changes.saved = false;
      displayForm(app.cache.savedForm);
      break;
    }
    case 'itemNote': {
      const barcode = String(options[0]),
            itemId = String(options[1]),
            note = String(options[2]);
      const items = JSON.parse(app.pages.form.elements.form.items.value);
      if (itemId == '') {
        const item = items.find(i => i.barcode == barcode);
        item.notes = note;
      } else {
        const item = items.find(i => i.id == itemId);
        item.notes = note;
      }
      app.pages.form.elements.form.items.value = JSON.stringify(items);
      utility.DOM.empty(app.pages.form.elements.itemList);
      items.reverse().forEach(populateItemList);
      break;
    }
    case 'itemQuantity': {
      const description = app.modal.tmp;
      const quantity = +app.modal.getInput();
      const items = JSON.parse(app.pages.form.elements.form.items.value);
      // note: we shouldn't be here unless item is not serialized, thus description is unique
      const item = items.find(i => i.description == description);
      const itemchange = {
        target: {
          name: 'items',
          value: description + ' qty ' + item.quantity,
        }
      };
      if (quantity < 1 || isNaN(quantity) ||
          Math.floor(quantity) != quantity) {
        app.modal.handleError(
          new Error("Invalid quantity: " + quantity +
            ". Use a positive number.  Scan the item again to check-in."
          )
        );
        return;
      }
      // is the item on the saved form? Quantity cannot be decreased.
      const savedItem = app.cache.savedForm.items.find(i => i.description == description);
      if (savedItem && quantity < savedItem.quantity) {
        app.modal.handleError(
          new Error(quantity + " is less than the previous quantity " +
            savedItem.quantity + ". You can only enter a larger amount " +
            "or check in this item."
          )
        );
        return;
      }
      item.quantity = quantity;
      // Update form.items
      app.pages.form.elements.form.items.value = JSON.stringify(items);
      // Update display
      utility.DOM.empty(app.pages.form.elements.itemList);
      items.reverse().forEach(populateItemList);
      // Fake change event
      itemchange.target.value += ' to ' + quantity;
      app.pages.form.handleChange(itemchange);
      break;
    }
    case 'newNote':
      app.modal.getNote();
      break;
    case 'newManual':
      // TODO check if manual already exists
      app.modal.getManual();
      break;
    case 'nextForm':
      if (! app.changes.saved) {
        app.modal.handleUnsavedForm(command);
        return;
      }
      app.pages.form.getNext();
      break;
    case 'openForms':
      if (! app.changes.saved) {
        app.modal.handleUnsavedForm(command);
        return;
      }
      app.spinner.on();
      app.run.doGet({ get: 'openForms' });
      break;
    case 'parseOmnibox':
      app.omnibox.parse();
      break;
    case 'previousForm':
      if (! app.changes.saved) {
        app.modal.handleUnsavedForm(command);
        return;
      }
      app.pages.form.getPrevious();
      break;
    case 'query':
      app.pages.archive.query();
      break;
    case 'revert':
      app.changes.saved = true;
      app.pages.form.elements.undoButton.setAttribute('disabled', true);
      app.pages.form.elements.updateButtonHint.textContent = '';
      app.pages.form.elements.updateFormButton.setAttribute('disabled', true);
      displayForm(app.cache.savedForm);
      break;
    case 'saveNote': {
      const notes = JSON.parse(app.pages.form.elements.form.notes.value);
      const note = {
        timestamp: Date.now(),
        author: app.elements.usernameDisplay.textContent,
        body: app.modal.getText(),
      };
      let shortNotes = note.body;
      if (shortNotes.length > 10) {
        shortNotes = shortNotes.slice(0, 10) + "...";
      }
      const noteChange = {
        target: {
          name: 'notes',
          value: shortNotes
        }
      };
      const p = document.createElement('p');
      p.textContent = 'Note: ' + '[' + note.author + '] ' + note.body;

      notes.push(note);
      app.pages.form.elements.form.notes.value = JSON.stringify(notes);
      app.pages.form.handleChange(noteChange);

      app.pages.form.elements.noteSection.appendChild(p);
      if (app.pages.form.elements.noteSection.classList.contains('hidden')) {
        app.pages.form.elements.noteSection.classList.remove('hidden');
      }
      break;
    }
    case 'saveManual': {
      const description = app.modal.getText();
      utility.digestMessage(description).then(hash =>{
        app.omnibox.handleItem({
          id: "MANUAL-"+ utility.hexString(hash).substring(0, 5),
          checkIn: null,
          checkOut: null,
          quantity: 1,
          serialized: false,
          barcode: null,
          description,
          checkedOut: true,
          notes: 'Notes: '
        });
      });
      break;
    }
    case 'setLocationOther': {
      const otherLocation = app.modal.getInput(),
            option = app.pages.form.elements.locationOtherOption,
            select = app.pages.form.elements.form.location,
            change = {
              target: {
                name  :'location',
                value :otherLocation
              }
            };
      select.value = option.value = otherLocation;
      app.pages.form.handleChange(change);
      option.textContent = otherLocation; // must follow handleChange
      break;
    }
    case 'signatureRecheck':
      window.clearTimeout(app.cache.signatureTimeoutId);
      app.run.doGet({ get: 'students',  init: false});
      break;
    case 'signatureSubmit': {
      const dataURL = app.modal.signaturePad.toDataURL(),
            studentId = app.modal.tmp;
      app.run.doPost({ post: 'signature', dataURL: dataURL, id: studentId });
      break;
    }
    case 'sortForms': {
      const sortType = options[0],
            forms = utility.sortForms(app.cache[app.cache.currentFormstack], sortType);
      if (app.cache.currentFormstack == app.strings.formstack.openForms) {
        populateFormsTable(forms);
      } else {
        populateArchiveTable(forms);
      }
      break;
    }
    case 'studentNote': {
      const radio = app.modal.table.querySelectorAll('input[type="radio"]');
      let value;
      for (let i = 0; i < radio.length; i++) {
        if (radio[i].checked) {
          if (radio[i].value == 'other') {
            value = app.modal.getText();
            break;
          } else {
            value = radio[i].value;
            break;
          }
        }
      }
      if (! value) {
        app.modal.handleError(
          new Error('an error has occured while getting student note')
        );
      }
      // TODO this is a cut, paste and modify version of 'saveNote'; refactor
      const notes = JSON.parse(app.pages.form.elements.form.notes.value);
      const note = {
        timestamp: Date.now(),
        author: app.elements.usernameDisplay.textContent,
        body: app.modal.tmp + ': ' + value,
      };
      let shortNotes = note.body;
      if (shortNotes.length > 10) {
        shortNotes = shortNotes.slice(0, 10) + "...";
      }
      const noteChange = {
        target: {
          name: 'notes',
          value: shortNotes
        }
      };
      const para = document.createElement('p');
      para.textContent = 'Note: ' + '[' + note.author + '] ' + note.body;

      notes.push(note);
      app.pages.form.elements.form.notes.value = JSON.stringify(notes);
      app.pages.form.handleChange(noteChange);

      app.pages.form.elements.noteSection.appendChild(para);
      if (app.pages.form.elements.noteSection.classList.contains('hidden')) {
        app.pages.form.elements.noteSection.classList.remove('hidden');
      }
      break;
    }
    case 'updateForm':
      app.omnibox.parse();
      app.spinner.inside(app.pages.form.elements.updateFormButton);
      app.run.doPost({ post: 'updateForm', form: JSON.stringify(utility.makeForm()) });
      break;
    case 'undo':
      app.modal.handleUndo();
      break;
  }
};
</script>
