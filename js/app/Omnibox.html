<script>
/* global
app
isCheckOutStudentOk
isCheckInItemOk
populateItemList
populateStudentList
utility
*/
app.omnibox = {
  clear: function() {
    app.omnibox.element.value = '';
  },
  element: document.querySelector('input.omnibox'),
  /** TODO - handle qty input or multiple scans of things like cables */
  handleItem: function(item, quantityToReturn) {
    const items = (JSON.parse(app.pages.form.elements.form.items.value) || []);
    const itemOnForm = items.find(i => {
      if (item.id && i.id == item.id) {
        return true;
      }
      if (item.barcode && i.barcode == item.barcode) {
        return true;
      }
      return false;
    });
    const change = { // fake change event
      target: {
        name: 'items',
        value: (item.id && ! /^manual/i.test(item.id))
          ? item.id
          : item.description
      }
    };

    if (! itemOnForm) { // new item
      item.checkOut = utility.date.getFormattedDate(new Date());
      items.push(item);
      change.target.value += ' check-out';
    } else if (quantityToReturn && quantityToReturn != "all") {
      itemOnForm.quantity -= quantityToReturn;
      change.target.value = `returned ${quantityToReturn} ${change.target.value}`;
    } else {
      if (itemOnForm.checkOut && itemOnForm.checkIn) { // checkout again?
        app.modal.handleError(
          new Error(itemOnForm.description + ' was already checked back in.')
        );
        // special case: delete manual item barcode; confusing to user otherwise
        if (app.omnibox.element.value == app.strings.manualItemBarcode) {
          app.omnibox.clear();
          return;
        }
        app.omnibox.element.classList.add('error');
        window.setTimeout(
          () => app.omnibox.element.classList.remove('error'), 2000
        );
        return;
      } else if (itemOnForm.checkOut) { // Its a check-in
        if (! isCheckInItemOk(itemOnForm)) {
          return;
        }
        itemOnForm.checkIn = utility.date.getFormattedDate(new Date());
        // clears the missing property if it was set.
        itemOnForm.missing = false;
        change.target.value += ' check-in';
      } else { // Its a check-out for reserved gear
        itemOnForm.checkOut = utility.date.getFormattedDate(new Date());
        change.target.value += ' check-out';
      }
    }

    // Update form.items
    app.pages.form.elements.form.items.value = JSON.stringify(items);
    // Update display
    utility.DOM.empty(app.pages.form.elements.itemList);
    items.reverse().forEach(populateItemList);
    app.omnibox.clear();
    // Fake change event
    app.pages.form.handleChange(change);
  },
  handleKeydown: function(keydown) {
    if (keydown.key == 'Enter') {
      keydown.preventDefault();
      app.omnibox.parse();
      return;
    } else if (keydown.key == 'Escape') {
      app.omnibox.element.blur();
    } else {
      // TODO auto-complete suggestions
    }
  },
  /** TODO */
  handleNewCodabar: function(codabar /* string */) {
    // use modal
    app.modal.getNewCodabar(codabar);
  },
  /** @param {Student} input */
  handleStudent: function(student) {
    let students = (
      JSON.parse(app.pages.form.elements.form.students.value) || []
    );
    let studentOnForm = students.find(s => s.id == student.id);
    let change = { // fake change event
      target: {
        name: 'students',
        value: student.name
      }
    };

    if (! studentOnForm) {
      if (! student.signatureOnFile) {
        app.modal.signatureWait();
        app.run.doPost({ post: 'startSignature', netid: student.netId });
        app.cache.signatureTimeoutId = window.setTimeout(
          () => app.run.doPost({ post: 'signatureTimeout' }),
          (10 * 60 * 1000) /* 10 minutes */);
        return;
      }
      student.checkIn = utility.date.getFormattedDate(new Date());
      students.push(student);
      change.target.value += ' check-in';
    } else {
      try {
        if (studentOnForm.checkIn && studentOnForm.checkOut) {
          throw new Error(studentOnForm.name + ' is already checked out.');
        } else if (studentOnForm.checkIn) {
          if (isCheckOutStudentOk(student)) {
            studentOnForm.checkOut = utility.date.getFormattedDate(new Date());
            change.target.value += ' check-out';
          } else {
            throw new Error(app.strings.studentCheckOutError);
          }
        } else {
          if (! student.signatureOnFile) {
            app.modal.signatureWait();
            app.run.doPost({ post: 'startSignature', netid: student.netId});
            app.cache.signatureTimeoutId = window.setTimeout(
              () => app.run.doPost({ post: 'signatureTimeout' }),
              (10 * 60 * 1000) /* 10 minutes */);
            return;
          } else {
            studentOnForm.checkIn = utility.date.getFormattedDate(new Date());
            change.target.value += ' check-in';
          }
        }

      }
      catch(error) {
        app.modal.handleError(error);
        app.omnibox.element.classList.add('error');
        window.setTimeout(
          () => app.omnibox.element.classList.remove('error'), 2000
        );
        return;
      }
    }
    // Update form.students
    app.pages.form.elements.form.students.value = JSON.stringify(students);
    // Update display
    utility.DOM.empty(app.pages.form.elements.studentList);
    students.forEach(populateStudentList);
    app.omnibox.clear();
    // Fake change event
    app.pages.form.handleChange(change);
  },
  /**
   * parse examines the current value of the omnibox text input element
   *   and passes the value to the correct handler or shows the user an error.
   */
  parse: function() {
    let value = app.omnibox.element.value;

    if (! value) { // nothing was entered, abort
      return;
    }
    
    const jsonRegex = /^\s*\[\s*{\s*"/;
    if (jsonRegex.test(value)) {
      const pasted = JSON.parse(value);
      pasted.forEach(utility.item.getCached); // verifies non-manual items match inventory
      pasted.forEach(app.omnibox.handleItem);
      return;
    }

    value = value.toLowerCase(); // case insenstive input
    let parsed;
    // DETERMINE TYPE: ID card barcode, item barcode, item ID/SKU, student name
    const codabarRegex = /^[a-d][0-9]{5,}[a-d]$/; // "a123...789b" pattern
    if (codabarRegex.test(value)) { // Check student id
      parsed = app.cache.students.find(
        student => student.id.toLowerCase() == value
      );
      if (parsed) {
        app.omnibox.handleStudent(parsed);
        return;
      } else {
        app.omnibox.handleNewCodabar(value);
        return;
      }
    }

    const idType = /^[a-z]+[0-9]+/.test(value) ? 'netId' : 'name'; // Check student name and id
    parsed = app.cache.students.find(
      student => student[idType].toLowerCase() == value
    );
    if (parsed) {
      app.modal.manualEntryAlert(app.omnibox.element.value);
      app.omnibox.handleStudent(parsed);
      return;
    }

    const itemIdregex = /[A-Za-z]+-[A-Za-z0-9]+/, // letter(s), hyphen, digit(s) or letter(s)
          barcoderegex = /^[0-9]+$/;              // only digits
    if (itemIdregex.test(value)) {
      const dashzero = /-0+/; // dash then one or more zeroes
      value = value.replace(dashzero, '-'); // strip leading zeroes
      parsed = app.cache.items.find(
        item => item.id.toLowerCase().replace(dashzero, '-') == value
      );
      if (!parsed && /^manual/.test(value)) {
        parsed = (JSON.parse(app.pages.form.elements.form.items.value)).find(
          item => item.id.toLowerCase().replace(dashzero, '-') == value
        );
      } else {
        app.modal.manualEntryAlert(app.omnibox.element.value);
      }
    } else if (barcoderegex.test(value)) { // assume it's a barcode
      if (value == app.strings.manualItemBarcode) {
        app.omnibox.clear();
        app.doCommand("newManual");
        return;
      }
      parsed = app.cache.items.find(item => {
        if (! item.barcode) {
          return false;
        }
        const barcode = "" + item.barcode;
        return barcode.toLowerCase() == value;
      });
    }
    if (parsed) {
      app.omnibox.handleItem(parsed);
      return;
    }

    // end of checks; if still in the function then show the user an error
    app.modal.handleError(new Error(value + ' ' + app.strings.parserError));
    app.omnibox.element.classList.add('error');
    window.setTimeout(
      () => app.omnibox.element.classList.remove('error'), 2000
    );
  },
};
</script>
