<script>
/**
 * this is the bootstrap script for the client-side code
 * any initial server-side calls, registering event listeners, etc go here
 */
/* global app google */

/** Event Listeners */
// MODAL
app.modal.cancel.addEventListener('click', app.modal.hide);
app.modal.clear.addEventListener('click', () => app.modal.signaturePad.clear());
app.modal.ok.addEventListener('click', app.modal.hide);
app.modal.textarea.addEventListener('keydown', function(keydown) {
  if (keydown.key == 'Enter' && (keydown.metaKey || keydown.ctrlKey)) {
    app.modal.hide();
    app.doCommand(app.modal.ok.value);
    keydown.stopPropagation(); // because same keys active update button
  }
});

// OMNIBOX
app.omnibox.element.addEventListener('keydown', app.omnibox.handleKeydown);

// ARCHIVE (Closed Forms)
app.pages.archive.elements.tableBody.addEventListener(
  'click', app.pages.archive.handleClickTable
);
app.pages.archive.elements.queryInputs.addEventListener(
  'change', app.pages.archive.handleChange
);

// FORM (single view)
app.pages.form.elements.container.addEventListener(
  'change', app.pages.form.handleChange
);
app.pages.form.elements.container.addEventListener(
  'submit', event => event.preventDefault()
);
app.pages.form.elements.container.addEventListener(
  'click', app.pages.form.handleClickTable
);
// focus guards create a tab/shift-tab closed loop through the form inputs 
app.pages.form.elements.focusGuardTop.addEventListener(
  'focus', () => app.pages.form.elements.locationSelect.focus()
);
app.pages.form.elements.focusGuardBottom.addEventListener(
  'focus', () => app.omnibox.element.focus()
);
//app.pages.form.elements.itemList.addEventListener(
//  'click', app.pages.form.handleClickItem
//);
app.pages.form.elements.studentList.addEventListener(
  'click', app.pages.form.handleClickStudent
);

// OPEN FORMS
app.pages.openForms.elements.equipmentTableBody.addEventListener(
  'click', app.pages.openForms.handleClickTable
);
app.pages.openForms.elements.formsTableBody.addEventListener(
  'click', app.pages.openForms.handleClickTable
);
app.pages.openForms.elements.formsTableHead.addEventListener(
  'click', app.pages.openForms.handleClickTableHead
);

// GLOBAL
window.addEventListener('beforeunload', app.handlers.beforeunload);
window.addEventListener('click', app.handlers.clickButton);
window.addEventListener('keydown', app.handlers.keydown);

/** Display init - anything to do with what the user sees immediately */
app.modal.hide(); // make sure everything is hidden that is supposed to be
app.spinner.on(); // no pages displayed; only spinner

app.pages.archive.init(); // Set date inputs to today

// Server runners
app.withErrorHandler = google.script.run.withFailureHandler(
  app.modal.handleError
);
app.run = app.withErrorHandler.withSuccessHandler(
  app.refresh
);

/** Server calls - the initial server calls that happen automatically */
app.run.doGet({ get: 'openForms', init: true }); // displays open forms
app.run.doGet({ get: 'user' });                  // displays username
app.run.doGet({ get: 'students',  init: true }); // gets the student info cache
app.run.doGet({ get: 'items' });                 // gets the item info cache
app.run.doGet({
  get: 'archive',
  dateRangeJSON: app.pages.archive.getDateRangeAsJSON(),
  init: true,
});
</script>
