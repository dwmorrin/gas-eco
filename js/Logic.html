<script>
/* global app */

/** @return {bool} */
function isAllGearReturned() {
  let items = JSON.parse(app.pages.form.elements.form.items.value);
  return items.every(item => {
    if(item.checkOut) {
      return item.checkIn || item.missing;
    } else {
      return true;
    }
  });
}

/**
 * @param {object} form
 * @returns {bool}
 */
/* exported isBlankForm */
function isBlankForm(form) {
  return form.id == null;
}

/** @return {bool} */
function isThereAnActiveStudent() {
  let students = JSON.parse(app.pages.form.elements.form.students.value),
      studentCounter = function(count, student) {
        if(student.checkIn && !(student.checkOut || student.left)) {
          return count + 1;
        } else {
          return count;
        }
      };
  let activeStudents = students.reduce(studentCounter, 0);
  return activeStudents > 1;
}

/**
 * @return {bool}
 */
/* exported isCheckInItemOk */
function isCheckInItemOk(item) {
  const savedItem = app.cache.savedForm.items.find(i => {
    if (i.id && i.id == item.id) {
      return true;
    }
    if (i.barcode && i.barcode == item.barcode) {
      return true;
    }
    return false;
  });
  if (! savedItem || ! savedItem.checkOut) {
    app.omnibox.clear();
    if (! item.serialized) {
      app.modal.handleQuantityChange(item.description);
      return false;
    }
    app.modal.handleError(
      new Error(
        item.description + " was just checked-out.  Update or revert the form to continue."
      )
    );
    return false;
  }
  return true;
}

/** @return {bool} */
/* exported isCheckOutStudentOk */
function isCheckOutStudentOk(student) {
  // check if the student just checked in by looking at the saved form
  let savedStudent = app.cache.savedForm.students.find(s => s.id == student.id);
  if(!savedStudent.checkIn) { // => this student just checked in
    app.modal.handleError(new Error(student.name + ' was just checked-in.  Update the form before checking out.'));
    return false;
  }
  return isThereAnActiveStudent() || isAllGearReturned();
}

/** @return {bool} */
/* exported isFormOkToPost */
function isFormOkToPost() {
  let elements = app.pages.form.elements;
  if (elements.locationSelect.value == 'none' || elements.locationSelect.value == '') {
    return false;
  }
  if (elements.form.startTime.value == elements.form.endTime.value) {
    return false;
  }
  if (elements.form.endDate.classList.contains('error')) {
    return false;
  }
  if (elements.form.startDate.classList.contains('error')) {
    return false;
  }
  let students = JSON.parse(app.pages.form.elements.form.students.value),
      items = JSON.parse(app.pages.form.elements.form.items.value);
  let someStudentsAreActive = students.some(s => (s.checkIn && !(s.checkOut || s.left)));
  let someItemsAreOut = items.some(i => (i.checkOut && !(i.checkIn || i.missing)));
  if(someItemsAreOut && !someStudentsAreActive) {
    return false;
  }
  // finally, is anybody on the form??
  if (students.length == 0) {
    return false;
  }
  return true;
}

/** @return {bool} */
/* exported isFormReadyToClose */
function isFormReadyToClose() {
  let students = JSON.parse(app.pages.form.elements.form.students.value);
  // Need at least 1 check-in, and everyone checked-in must be checked-out
  return students.some(student => student.checkIn) && students.every(
    student => {
      if(student.checkIn) {
        return student.checkOut || student.left;
      } else {
        return true;
      }
    }
  );
}

/** @return {bool} */
/* exported isNoShow */
function isNoShow(form) {
  if (!form.id) {
    return false; // we are only looking at booked forms
  }
  const gracePeriod = 15; // minutes
  let start = new Date(form.startTime),
      now = Date.now();
  start.setMinutes(start.getMinutes() + gracePeriod);
  if(now > start.getTime() && !form.students.some(s => s.checkIn)) {
    return true;
  } else {
    return false;
  }
}
</script>
